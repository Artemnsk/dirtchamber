function noReproduction(){}function reproduceAndPlaceNearRandomly(){if(Math.random()<=.005){var a=[],b=[-1,0,1];for(var c in b)for(var d in b)1===c&&1===d||0===this.env.env[this.x][this.y].microbes.length&&this.x+b[c]>=0&&this.x+b[c]<this.env.configs.maxX&&this.y+b[d]>=0&&this.y+b[d]<this.env.configs.maxY&&a.push({x:this.x+b[c],y:this.y+b[d]});if(a.length>0){var e=a[randomNumberFromRange(0,a.length-1)],f=new Food(e.x,e.y,this.env,{type:"direct"});this.env.env[e.x][e.y].food.push(f),this.env.food.push(f)}}}function reproduceUderYouself(){if(Math.random()<=.005){var a=this.x,b=this.y,c=new Food(a,b,this.env,{type:"direct"});this.env.env[a][b].food.push(c),this.env.food.push(c)}}function randomNumberFromRange(a,b){return Math.floor(Math.random()*(b-a)+a)}var Player=function(a,b,c){this.nickname=a,this.color=b;var d=this;this.algorithm=c||function(a,b,c,e,f,g){for(var h=!1,i=0;i<a.length;i++)try{var j=JSON.parse(a[i].text);if("food"===j.type){e(j.x-b,j.y-c),h=!0;break}}catch(a){}if(!h){e(randomNumberFromRange(-1,2),randomNumberFromRange(-1,2))}f(),g(d.nickname)}},Message=function(a,b,c,d,e){this.x=b,this.y=c,this.player=e,this.step=d.current_step,this.text=a},Microbe=function(a,b,c,d,e){this.player=e,this.env=c,this.speed=1,this.hitpoints=d,this.x=a,this.y=b,this.env.microbes.push(this),this.env.env[this.x][this.y].microbes.push(this)};Microbe.prototype.live=function(){if(this.player&&this.player instanceof Player){var a=this,b=!1,c=function(c,d){b===!1&&(b=!0,a.move(c,d))},d=!1,e=function(){d===!1&&(d=!0,a.reproduce_request())},f=!1,g=function(b){f===!1&&(f=!0,a.yell(b))},h=this.env.getMessages(this.x,this.y);this.player.algorithm.call(null,h,this.x,this.y,this.hitpoints,c,e,g)}},Microbe.prototype.move=function(a,b){if($.isNumeric(a)||(a=0),$.isNumeric(b)||(b=0),a=Math.round(a),b=Math.round(b),0!==a||0!==b){Math.abs(a)>1&&(a=Math.sign(a)),Math.abs(b)>1&&(b=Math.sign(b));var c=this.env.env[this.x][this.y].microbes.indexOf(this);this.env.env[this.x][this.y].microbes.splice(c,1),this.x+=this.speed*a,this.y+=this.speed*b,this.x<this.env.configs.minX?this.x=this.env.configs.minX:this.x>=this.env.configs.maxX&&(this.x=this.env.configs.maxX-1),this.y<this.env.configs.minY?this.y=this.env.configs.minY:this.y>=this.env.configs.maxY&&(this.y=this.env.configs.maxY-1),this.env.env[this.x][this.y].microbes.push(this)}},Microbe.prototype.reproduce_request=function(){this.env.microbes_to_reproduce.indexOf(this)===-1&&this.env.microbes_to_reproduce.push(this)},Microbe.prototype.reproduce=function(){this.env.getMicrobesQuantityByPlayer(this.player,this.env.microbes)<=this.env.configs.population_limit&&(this.hitpoints=Math.round(this.hitpoints/2),new Microbe(this.x,this.y,this.env,this.hitpoints,this.player))},Microbe.prototype.yell=function(a){var b=new Message(a,this.x,this.y,this.env,this.player);this.env.messages.push(b),this.env.env[this.x][this.y].messages.push(b)},Microbe.prototype.giveEnvironmentInfo=function(){var a={x:this.x,y:this.y,player:this.player.nickname,type:"microbe",hitpoints:this.hitpoints};return JSON.stringify(a)};var Food=function(a,b,c,d){this.x=a,this.y=b,this.env=c,this.height=10,this.x=a,this.y=b,this.env.env[this.x][this.y].food.push(this),this.env.food.push(this)};Food.prototype.live=function(){this.reproduce()},Food.prototype.giveEnvironmentInfo=function(){var a={x:this.x,y:this.y,type:"food",height:this.height};return JSON.stringify(a)},Food.prototype.reproduce=noReproduction;var Game=function(a,b,c){this.configs=b,this.env=new Environment(c),this.players=a,this.status="prepare",this.winner=null};Game.prototype.settle=function(){randomSettle.call(this)},Game.prototype.processEnd=function(){if("results"===this.status)return!0;if("ended"===this.status)return this.endGame(),this.status="results",!0;if(0===this.env.microbes.length)return this.winner=null,this.status="ended",!0;for(var a=!0,b=null,c=0;c<this.env.microbes.length;c++)if(null===b&&(b=this.env.microbes[c].player),b!==this.env.microbes[c].player){a=!1;break}if(a)return this.winner=this.env.microbes[0].player,this.status="ended",!0;if(this.env.current_step>=this.configs.max_steps){var d=this.getOverallHitpointsByPlayer(this.env.microbes),e=d.players,f=d.hitpoints;if(e.length>1){for(var g=0,c=1;c<f.length;c++)f[c]>f[g]&&(g=c);return this.winner=e[g],this.status="ended",!0}}},Game.prototype.endGame=function(){var a="";a=null!==this.winner?this.winner.nickname+" wins!":"Game ended in a draw.",$("#result").html(a)};var randomSettle=function(){var a=[];switch(this.players.length){default:case 2:a=[{x:this.env.configs.minX,y:Math.round(this.env.configs.maxY/2)},{x:this.env.configs.maxX,y:Math.round(this.env.configs.maxY/2)}]}for(var b=0;b<this.configs.microbes_starting_population;b++){for(var c=0;c<this.players.length;c++)new Microbe(a[c].x,a[c].y,this.env,9999999,this.players[c]);for(var d=0;d<this.configs.food_starting_population;d++){new Food(randomNumberFromRange(this.env.configs.minX,this.env.configs.maxX),randomNumberFromRange(this.env.configs.minY,this.env.configs.maxY),this.env)}}},Environment=function(a){for(this.configs=a,this.current_step=0,this.microbes_to_reproduce=[],this.microbes=[],this.messages=[],this.food=[],this.env={},i=this.configs.minX;i<=this.configs.maxX;i++)for(this.env[i]={},j=this.configs.minY;j<=this.configs.maxY;j++)this.env[i][j]={microbes:[],messages:[],food:[]};var b=document.getElementById("Area"),c=b.getContext("2d");c.canvas.height=(this.configs.maxY-this.configs.minY)*this.configs.draw_scale,c.canvas.width=(this.configs.maxX-this.configs.minX)*this.configs.draw_scale};Environment.prototype.draw=function(){var a=document.getElementById("Area"),b=a.getContext("2d"),c=this.configs.draw_scale;b.clearRect(0,0,this.configs.maxX*c,this.configs.maxY*c);for(var d in this.env)for(var e in this.env[d])this.env[d][e].microbes.length>0&&(b.fillStyle=this.env[d][e].microbes[0].player.color,b.fillRect(d*c,e*c,c,c)),this.env[d][e].food.length>0&&(b.fillStyle="green",b.fillRect(d*c,e*c,c,c))},Environment.prototype.step=function(){this.prepareEnvironmentInfo(),this.current_step++;for(var a in this.microbes)this.microbes[a].live();for(var a in this.food)this.food[a].live();for(;this.microbes_to_reproduce.length>0;){var b=this.microbes_to_reproduce[0],a=this.microbes.indexOf(b);this.microbes_to_reproduce.splice(0,1),a!==-1?this.microbes[a].reproduce():console.log("Trying to reproduce microbe which doesnt exist any more.")}for(var c in this.env)for(var d in this.env[c])this.processLayerItem(this.env[c][d]);for(var c=0;c<this.messages.length;)if(this.messages[c].step<this.current_step){var a=this.env[this.messages[c].x][this.messages[c].y].messages.indexOf(this.messages[c]);this.env[this.messages[c].x][this.messages[c].y].messages.splice(a,1),this.messages.splice(c,1)}else c++},Environment.prototype.processLayerItem=function(a){if(a.microbes.length>1){var b=this.getOverallHitpointsByPlayer(a.microbes),c=b.players,d=b.hitpoints;if(c.length>1){for(var e=0,f=1;f<d.length;f++)d[f]>d[e]&&(e=f);for(var g=c[e],f=0;f<a.microbes.length;f++)a.microbes[f].player!==g&&(a.microbes[f].hitpoints=0)}}for(var f=0;f<a.microbes.length;)if(a.microbes[f].hitpoints-=41,a.microbes[f].hitpoints<=0){var h=this.microbes.indexOf(a.microbes[f]);this.microbes.splice(h,1),a.microbes.splice(f,1)}else f++;if(a.food.length>0&&a.microbes.length>0)for(var f=0;f<a.microbes.length;f++)for(var i=0;i<a.food.length;i++)a.food[i].height<=0||(a.food[i].height--,a.microbes[f].hitpoints+=Math.round(this.configs.hitpoints_per_food));for(var f=0;f<a.food.length;)if(a.food[f].height<=0){var h=this.food.indexOf(a.food[f]);this.food.splice(h,1),a.food.splice(f,1)}else f++},Environment.prototype.getMessages=function(a,b){for(var c=[],d=a-this.configs.message_radius;d<=a+this.configs.message_radius;d++)if(this.configs.minX<=d&&d<=this.configs.maxX)for(var e=b-this.configs.message_radius;e<=b+this.configs.message_radius;e++)if(this.configs.minY<=e&&e<=this.configs.maxY)for(var f=0;f<this.env[d][e].messages.length;f++)this.env[d][e].messages[f].step<this.current_step&&c.indexOf(this.env[d][e].messages[f])===-1&&c.push(this.env[d][e].messages[f]);return c},Environment.prototype.prepareEnvironmentInfo=function(){for(var a=this.configs.minX;a<=this.configs.maxX;a++)for(var b=this.configs.minY;b<=this.configs.maxY;b++){for(var c=0;c<this.env[a][b].microbes.length;c++){var d=new Message(this.env[a][b].microbes[c].giveEnvironmentInfo(),a,b,this,null);this.messages.push(d),this.env[a][b].messages.push(d)}for(var c=0;c<this.env[a][b].food.length;c++){var d=new Message(this.env[a][b].food[c].giveEnvironmentInfo(),a,b,this,null);this.messages.push(d),this.env[a][b].messages.push(d)}}},Environment.prototype.getOverallHitpointsByPlayer=function(a){for(var b=[],c=[],d=0;d<a.length;d++){var e=b.indexOf(a[d].player);e===-1&&(b.push(a[d].player),e=b.length-1,c[e]=0),c[e]+=a[d].hitpoints}return{players:b,hitpoints:c}},Environment.prototype.getMicrobesQuantityByPlayer=function(a,b){for(var c=0,d=0;d<b.length;d++)b[d].player===a&&c++;return c};var startGame=function(){algorithm1=new Function("messages","my_x","my_y","my_hitpoints","microbe_move","microbe_reproduce","microbe_yell",$('#player1 *[name="algorithm"]').val()),algorithm2=new Function("messages","my_x","my_y","my_hitpoints","microbe_move","microbe_reproduce","microbe_yell",$('#player2 *[name="algorithm"]').val());var a=new Player($('#player1 *[name="nickname"]').val(),$('#player1 *[name="color"]').val(),algorithm1),b=new Player($('#player2 *[name="nickname"]').val(),$('#player2 *[name="color"]').val(),algorithm2),c=[a,b],d={max_steps:9999999999,microbes_starting_population:1,food_starting_population:200},e={maxX:200,maxY:200,minX:0,minY:0,population_limit:500,draw_scale:3,hitpoints_per_food:1e3,message_radius:2},f=new Game(c,d,e);f.settle(),setInterval(function(){f.processEnd()||(f.env.step(),f.env.draw())},41)},algorithm1=function(a,b,c,d,e,f,g){for(var h=!1,i=0;i<a.length;i++)try{var j=JSON.parse(a[i].text);if("food"===j.type){e(j.x-b,j.y-c),h=!0;break}}catch(a){}if(!h){var k=randomNumberFromRange(-1,2),l=randomNumberFromRange(-1,2);e(k,l),e(k,l)}Math.random()<=.005&&f()},algorithm2=function(a,b,c,d,e,f,g){e(randomNumberFromRange(-1,2),randomNumberFromRange(-1,2)),Math.random()<=.005&&f()};